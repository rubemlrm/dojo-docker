---
- name: "Deploy Service {{ outer_item.name }}"
  block:
    - name: Setup Ports
      become: true
      ansible.posix.firewalld:
        port: "{{ item }}"
        permanent: true
        immediate: true
        state: enabled
      with_items: "{{ outer_item.ports }}"
    - name: permit traffic in default zone for service
      become: true
      ansible.posix.firewalld:
        service: "{{ item }}"
        permanent: true
        immediate: true
        state: enabled
      with_items: "{{ outer_item.services }}"
    - name: "Create {{ outer_item.name }} service directories"
      file:
        path: "{{ docker_configs.data_path }}{{ item.path }}"
        state: directory
        owner: "{{ ( item.owner is defined and item.owner != '') | ternary(item.owner , username)}}"
      with_items: "{{ outer_item.directories }}"
    - name: "Setup {{ outer_item.name }} service"
      community.docker.docker_compose:
        state: present
        build: true
        project_src: "{{ role_path }}/files/services/{{ outer_item.name }}"
